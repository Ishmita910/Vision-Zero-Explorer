<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  
<!--   Map work  -->  

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

  <script src="https://cdn.rawgit.com/CartoDB/cartodb.js/@4.0.0-alpha.28/carto.js"></script>

  
  
  
<!-- Leaflet -->
  
<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/> -->
  
  
<!-- Make sure you put this AFTER Leaflet's CSS  -->
  
  
 <!--  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script> -->
 
  
  
  
<style id="jsbin-css">
.axis .domain {
  display: none;
}
/* div.static {
    position: static;
    border: 3px solid #73AD21;
} */
h3,h4 {
    white-space: nowrap;
}
/* svg:hover { 
    background-color: #d3d3d3;
}  */
rect:hover {fill:#bc5873}
</style>
</head>
<body>
<div id="mapid" style="width: 600px; height: 700px;"></div>

    <h4 id="map-heading" style="font-family:verdana;">Density of Vehicle Collisions  per Zip Code</h4>
  
<!--   <div id="myDivMap" name="myDivMap" title="Div Map Element">
    
  <iframe width="620" height="700" frameborder="0" src="https://nyu.carto.com/u/roshansridhar/builder/43f0ea12-8077-4cf5-8781-d99676560bc3/embed" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>
    </div> -->
  
  <h3 id="main-heading" style="font-family:verdana;">NYC Motor Vehicle Collisions Explorer</h3>
  
<div id="chart">
  <svg id="legend" width="750" height="710"> 
  </svg>
</div>
  
  <select id="inds" onchange="report(this.value)">
		<option value="none" selected="selected">None</option>
    <option value="m_inj">Motorists Injured</option>
		<option value="m_dead">Motorists Fatalaties</option>
		<option value="p_inj">Pedestrians Injured</option>
    <option value="p_dead">Pedestrians Fatalities</option>
		<option value="c_inj">Cyclists Injured</option>
		<option value="c_dead">Cyclist Fatalities</option>
  </select>
  
    <select id="facs" onchange="report3(this.value)">
		<option value="none" selected="selected">None</option>
    <option value="o1">Driver Inattention/Distraction</option>
		<option value="o2">Failure to Yield Right-of-Way</option>
		<option value="o3">Fatigued/Drowsy</option>
    <option value="o4">Backing Unsafely</option>
		<option value="o5">Other Vehicular</option>
		<option value="o6">Following Too Closely</option>
    <option value="o7">Turning Improperly</option>
		<option value="o8">Lost Consciousness</option>
    <option value="o9">Passing or Lane Usage Improper</option>
    <option value="o10">Traffic Control Disregarded</option>		
    <option value="o11">Driver Inexperience</option>
		<option value="o12">Prescription Medication</option>
    <option value="o13">Unsafe Lane Changing</option>
		<option value="o14">Pavement Slippery</option>
		<option value="o15">Outside Car Distraction</option>
    <option value="o16">Alcohol Involvement</option>
		<option value="o17">Physical Disability</option>
		<option value="o18">Oversized Vehicle</option>
    <option value="o19">Reaction to Other Uninvolved Vehicle</option>
    <option value="o20">Unsafe Speed</option>
  </select>
  
  <div id="git"  style="font-family:verdana;">
  For more information about the Vision Zero Project:
  <a href="https://github.com/Ishmita910/Vision-Zero-Explorer/blob/master/README.md">Click here</a>
 <br> To understand our Data Analysis :  <a href="https://github.com/Ishmita910/Vision-Zero-Explorer/blob/master/README.md">Click here</a>
  <br> Project documentation :  <a href="https://github.com/Ishmita910/Vision-Zero-Explorer">Click here</a>
  
  </div>
  
<!-- <div id="showAll">
  <input name="showAllButton"
   type="button"
   value="Show All"
   onclick="showAll()" />
</div>
<div id="clearAll">
  <input name="clearAllButton"
   type="button"
   value="Clear All"
   onclick="clearAll()" />
</div> -->
  
<script id="jsbin-javascript">
var map = L.map('mapid')
            .setView([40.692908,-73.9896452],
                     11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);
    L.control.scale().addTo(map);
    var cto = new carto.Client({
      apiKey: 'NotNeeded',
      username: 'roshansridhar'
    });
function removeAllLayersExcept(new_layer) {
  console.log('new_layer._leaflet_id:' + new_layer._leaflet_id);
  var layer_index = 0;
  map.eachLayer(function(layer) {
    if (layer_index > 0 && layer._leaflet_id != new_layer._leaflet_id) {
      console.log('layer removed:' + layer._leaflet_id);
      //map.removeLayer(layer);
      setTimeout(function () { // give a little time before removing previous tile layer because new one will appear with some transition.
        map.removeLayer(layer);
      }, 500);
    }
    layer_index++;
  });
}
function appendLayerQuery(dataset, query) {
    dataset.setQuery(query);
}
var sqlQuery = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions";
var emptyQuery = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE 1=0";
  var NYCDataset = new carto.source.SQL(sqlQuery);
function mapify(dataset, sqlQuery){
  var NYCPointStyle = new carto.style.CartoCSS(`
      #layer {
      marker-width: 7;
      marker-fill: ramp([zip_counts], (#f6d2a9, #f3aa84, #ea8171, #d55d6a, #b13f64), quantiles);
      marker-fill-opacity: 1;
      marker-allow-overlap: true;
      marker-line-width: 0;
      marker-line-color: #FFFFFF;
      marker-line-opacity: 1;
      }
  `);
  var NYCLayer = new carto.layer.Layer(dataset, NYCPointStyle);  
  cto.addLayer(NYCLayer);
  cto.getLeafletLayer().addTo(map);
  return NYCLayer;
}
// var lol = 
    mapify(NYCDataset, sqlQuery);
// appendLayerQuery(NYCDataset, emptyQuery);
// A function 'placeObj' to position an element in the canvas given the element ID and co-ordinates
function placeObj(id, x_pos, y_pos) {
  var d = document.getElementById(id);
  d.style.position = "absolute";
  d.style.left = x_pos+'px';
  d.style.top = y_pos+'px';
}
// Placing elements on the page using the above user-defined function
placeObj('main-heading',  20,   0);
placeObj( 'map-heading', 780,   0);
// placeObj(    'myDivMap', 770,  50);
placeObj(        'inds', 360, 272);
placeObj(        'facs', 360, 512);
placeObj(      'legend',  20,  40);
placeObj(         'git',  10, 800);
placeObj(       'mapid', 770,  50);
// Creating three groups on the svg for the grouped bar charts to be displayed.
var svg = d3.select("svg"),
    margin = {top: 30, right: 20, bottom: 30, left: 30}, 
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height")/3.1 - margin.top - margin.bottom,
    g1 = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
    g2 = svg.append("g").attr("id", "vis2").attr("transform", "translate(" + margin.left + "," + (250+margin.top) + ")"),
    g3 = svg.append("g").attr("id", "vis3").attr("transform", "translate(" + margin.left + "," + (490+margin.top) + ")");
var x0 = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.1);
var x1 = d3.scaleBand()
    .padding(0.05);
var y = d3.scaleLinear()
    .rangeRound([height, 0]);
var z3 = d3.scaleOrdinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
var z2 = d3.scaleOrdinal()
    .range(["#C28142", "#C4AC44", "#44833C", "#47933D", "#4AA43F", "#BD4052", "#C05640"]);
var z = d3.scaleOrdinal()
    .range(["#7e3961", "#8e3b6b", "#9f3d75", "#3e88b8", "#3e62bb", "#423ebf", "#6d3ec2"]);
// Appending text for drop down box
g2.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of injury/fatality to explore:");
// Appending text for drop down box
    g3.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of contributing factor to explore:");
// A user-defined function that creates a grouped bar chart based on the given group element of the svg, pivot data, Chart title and color scheme respectively
function dispViz(g_var, url, vtitle, color_sc){  
  g_var.append("text")
    .attr("x", 0)
    .attr("y", -10)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text(vtitle);
  
  d3.csv(url, function(d, i, columns) {
    for (var i = 1, n = columns.length; i < n; ++i) d[columns[i]] = +d[columns[i]];
    return d;
  },
  function(error, data) {
    if (error) throw error;
    var keys = data.columns.slice(1);
    x0.domain(data.map(function(d) { return d.BOROUGH; }));
    x1.domain(keys).rangeRound([0, x0.bandwidth()]);
    y.domain([0, d3.max(data, function(d) {
      return d3.max(keys, function(key) { return d[key]; }); })]).nice();
    g_var.append("g")
      .selectAll("g")
      .data(data)
      .enter().append("g")
        .attr("transform", function(d) { return "translate(" + x0(d.BOROUGH) + ",0)"; })
      .selectAll("rect")
      .data(function(d) { return keys.map(function(key) { return {key: key, value: d[key]}; }); })
      .enter()
      .append("rect")
        .attr("x", function(d) { return x1(d.key); })
        .attr("y", function(d) { return y(d.value); })
        .attr("width", x1.bandwidth()).transition().delay(250).duration(1000)
        .attr("height", function(d) { return height - y(d.value); })
        .attr("fill", function(d) { return color_sc(d.key); });
    g_var.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x0));
    g_var.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y).ticks(null, "s"))
      .append("text")
        .attr("x", 2)
        .attr("y", y(y.ticks().pop()) + 0.5)
        .attr("dy", "0.32em")
        .attr("fill", "#000")
        .attr("font-weight", "bold")
        .attr("text-anchor", "start")
        .text("Population");
    var legend = g_var.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "end")
      .selectAll("g")
      .data(keys.slice().reverse())
      .enter().append("g")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
    legend.append("rect")
        .attr("x", width - 19)
        .attr("width", 19)
        .attr("height", 19)
        .attr("fill", color_sc);
    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9.5)
        .attr("dy", "0.32em")
        .text(function(d) { return d; });
    });
  }  
// Function to get the name of the selected drop-down
function getSelectedText(elementId) 
{
  var elt = document.getElementById(elementId);      
  if (elt.selectedIndex == -1)         
    return null;      
  return elt.options[elt.selectedIndex].text; 
}  
// First visualization given the url to the data and the title
viz1_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz_block_1_pivot.csv"
viz1_title = "Total accidents per year for each borough:"
dispViz(g1, viz1_url, viz1_title, z);
// Function to return the respective parameters for the visualization function based on the selected option in the drop down menu
function report(v) {
  var text = this.getSelectedText('inds');
  viz_title = "Number of "+text+" per year for each borough:"
  
  // Clear element when selection is changed  
  var el = document.getElementById("vis2");
  el.innerHTML = '';
//   while (el.firstChild) {
//       el.removeChild(el.firstChild);
//   }
  appendLayerQuery(NYCDataset, emptyQuery);
  
  // Text explanation for the selection drop down
  g2.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of injury/fatality to explore:");
  
//To Do
  switch(v) {
    case "m_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20MOTORIST%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_motorist_injured > 0";
      
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "m_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20MOTORIST%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_motorist_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "p_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20PEDESTRIANS%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_pedestrians_injured > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "p_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20PEDESTRIANS%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_pedestrians_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "c_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20CYCLIST%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_cyclist_injured > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "c_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20CYCLIST%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_cyclist_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
      
  }
}
// Function to return the respective parameters for the visualization function based on the selected option in the drop down menu
function report3(v) {
  var text = this.getSelectedText('facs');
  viz_title = "Number of Accidents due to "+text+" per year for each borough:"
  // Clear element when selection is changed  
  var el = document.getElementById("vis3");
  el.innerHTML = '';
//   while (el.firstChild) {
//       el.removeChild(el.firstChild);
//   }
    appendLayerQuery(NYCDataset, emptyQuery);
  // Text explanation for the selection drop down
  g3.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of contributing factor to explore:");
  
//To Do
  switch(v) {
      
    case "o1":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Driver%20Inattention--Distraction.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Driver Inattention/Distraction'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o2":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Failure%20to%20Yield%20Right-of-Way.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Failure to Yield Right-of-Way'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o3":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Fatigued--Drowsy.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Fatigued/Drowsy'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o4":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Backing%20Unsafely.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Backing Unsafely'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o5":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Other%20Vehicular.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Other Vehicular'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o6":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Following%20Too%20Closely.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Following Too Closely'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o7":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Turning%20Improperly.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Turning Improperly'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o8":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Lost%20Consciousness.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Lost Consciousness'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o9":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Passing%20or%20Lane%20Usage%20Improper.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Passing or Lane Usage Improper'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o10":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Traffic%20Control%20Disregarded.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Traffic Control Disregarded'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o11":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Driver%20Inexperience.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Driver Inexperience'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o12":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Prescription%20Medication.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Prescription Medication'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o13":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Unsafe%20Lane%20Changing.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Unsafe Lane Changing'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o14":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Pavement%20Slippery.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Pavement Slippery'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o15":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Outside%20Car%20Distraction.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Outside Car Distraction'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o16":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Alcohol%20Involvement.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Alcohol Involvement'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o17":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Physical%20Disability.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Physical Disability'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o18":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Oversized%20Vehicle.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Oversized Vehicle'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o19":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Reaction%20to%20Other%20Uninvolved%20Vehicle.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Reaction to Other Uninvolved Vehicle'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o20":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Unsafe%20Speed.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Unsafe Speed'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
  }
}
</script>


<script id="jsbin-source-css" type="text/css"> .axis .domain {
  display: none;
}
/* div.static {
    position: static;
    border: 3px solid #73AD21;
} */
h3,h4 {
    white-space: nowrap;
}
/* svg:hover { 
    background-color: #d3d3d3;
}  */
rect:hover {fill:#bc5873}
</script>

<script id="jsbin-source-javascript" type="text/javascript">var map = L.map('mapid')
            .setView([40.692908,-73.9896452],
                     11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);
    L.control.scale().addTo(map);
    var cto = new carto.Client({
      apiKey: 'NotNeeded',
      username: 'roshansridhar'
    });
function removeAllLayersExcept(new_layer) {
  console.log('new_layer._leaflet_id:' + new_layer._leaflet_id);
  var layer_index = 0;
  map.eachLayer(function(layer) {
    if (layer_index > 0 && layer._leaflet_id != new_layer._leaflet_id) {
      console.log('layer removed:' + layer._leaflet_id);
      //map.removeLayer(layer);
      setTimeout(function () { // give a little time before removing previous tile layer because new one will appear with some transition.
        map.removeLayer(layer);
      }, 500);
    }
    layer_index++;
  });
}
function appendLayerQuery(dataset, query) {
    dataset.setQuery(query);
}
var sqlQuery = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions";
var emptyQuery = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE 1=0";
  var NYCDataset = new carto.source.SQL(sqlQuery);
function mapify(dataset, sqlQuery){
  var NYCPointStyle = new carto.style.CartoCSS(`
      #layer {
      marker-width: 7;
      marker-fill: ramp([zip_counts], (#f6d2a9, #f3aa84, #ea8171, #d55d6a, #b13f64), quantiles);
      marker-fill-opacity: 1;
      marker-allow-overlap: true;
      marker-line-width: 0;
      marker-line-color: #FFFFFF;
      marker-line-opacity: 1;
      }
  `);
  var NYCLayer = new carto.layer.Layer(dataset, NYCPointStyle);  
  cto.addLayer(NYCLayer);
  cto.getLeafletLayer().addTo(map);
  return NYCLayer;
}
// var lol = 
    mapify(NYCDataset, sqlQuery);
// appendLayerQuery(NYCDataset, emptyQuery);
// A function 'placeObj' to position an element in the canvas given the element ID and co-ordinates
function placeObj(id, x_pos, y_pos) {
  var d = document.getElementById(id);
  d.style.position = "absolute";
  d.style.left = x_pos+'px';
  d.style.top = y_pos+'px';
}
// Placing elements on the page using the above user-defined function
placeObj('main-heading',  20,   0);
placeObj( 'map-heading', 780,   0);
// placeObj(    'myDivMap', 770,  50);
placeObj(        'inds', 360, 272);
placeObj(        'facs', 360, 512);
placeObj(      'legend',  20,  40);
placeObj(         'git',  10, 800);
placeObj(       'mapid', 770,  50);
// Creating three groups on the svg for the grouped bar charts to be displayed.
var svg = d3.select("svg"),
    margin = {top: 30, right: 20, bottom: 30, left: 30}, 
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height")/3.1 - margin.top - margin.bottom,
    g1 = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
    g2 = svg.append("g").attr("id", "vis2").attr("transform", "translate(" + margin.left + "," + (250+margin.top) + ")"),
    g3 = svg.append("g").attr("id", "vis3").attr("transform", "translate(" + margin.left + "," + (490+margin.top) + ")");
var x0 = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.1);
var x1 = d3.scaleBand()
    .padding(0.05);
var y = d3.scaleLinear()
    .rangeRound([height, 0]);
var z3 = d3.scaleOrdinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
var z2 = d3.scaleOrdinal()
    .range(["#C28142", "#C4AC44", "#44833C", "#47933D", "#4AA43F", "#BD4052", "#C05640"]);
var z = d3.scaleOrdinal()
    .range(["#7e3961", "#8e3b6b", "#9f3d75", "#3e88b8", "#3e62bb", "#423ebf", "#6d3ec2"]);
// Appending text for drop down box
g2.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of injury/fatality to explore:");
// Appending text for drop down box
    g3.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of contributing factor to explore:");
// A user-defined function that creates a grouped bar chart based on the given group element of the svg, pivot data, Chart title and color scheme respectively
function dispViz(g_var, url, vtitle, color_sc){  
  g_var.append("text")
    .attr("x", 0)
    .attr("y", -10)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text(vtitle);
  
  d3.csv(url, function(d, i, columns) {
    for (var i = 1, n = columns.length; i < n; ++i) d[columns[i]] = +d[columns[i]];
    return d;
  },
  function(error, data) {
    if (error) throw error;
    var keys = data.columns.slice(1);
    x0.domain(data.map(function(d) { return d.BOROUGH; }));
    x1.domain(keys).rangeRound([0, x0.bandwidth()]);
    y.domain([0, d3.max(data, function(d) {
      return d3.max(keys, function(key) { return d[key]; }); })]).nice();
    g_var.append("g")
      .selectAll("g")
      .data(data)
      .enter().append("g")
        .attr("transform", function(d) { return "translate(" + x0(d.BOROUGH) + ",0)"; })
      .selectAll("rect")
      .data(function(d) { return keys.map(function(key) { return {key: key, value: d[key]}; }); })
      .enter()
      .append("rect")
        .attr("x", function(d) { return x1(d.key); })
        .attr("y", function(d) { return y(d.value); })
        .attr("width", x1.bandwidth()).transition().delay(250).duration(1000)
        .attr("height", function(d) { return height - y(d.value); })
        .attr("fill", function(d) { return color_sc(d.key); });
    g_var.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x0));
    g_var.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y).ticks(null, "s"))
      .append("text")
        .attr("x", 2)
        .attr("y", y(y.ticks().pop()) + 0.5)
        .attr("dy", "0.32em")
        .attr("fill", "#000")
        .attr("font-weight", "bold")
        .attr("text-anchor", "start")
        .text("Population");
    var legend = g_var.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "end")
      .selectAll("g")
      .data(keys.slice().reverse())
      .enter().append("g")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
    legend.append("rect")
        .attr("x", width - 19)
        .attr("width", 19)
        .attr("height", 19)
        .attr("fill", color_sc);
    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9.5)
        .attr("dy", "0.32em")
        .text(function(d) { return d; });
    });
  }  
// Function to get the name of the selected drop-down
function getSelectedText(elementId) 
{
  var elt = document.getElementById(elementId);      
  if (elt.selectedIndex == -1)         
    return null;      
  return elt.options[elt.selectedIndex].text; 
}  
// First visualization given the url to the data and the title
viz1_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz_block_1_pivot.csv"
viz1_title = "Total accidents per year for each borough:"
dispViz(g1, viz1_url, viz1_title, z);
// Function to return the respective parameters for the visualization function based on the selected option in the drop down menu
function report(v) {
  var text = this.getSelectedText('inds');
  viz_title = "Number of "+text+" per year for each borough:"
  
  // Clear element when selection is changed  
  var el = document.getElementById("vis2");
  el.innerHTML = '';
//   while (el.firstChild) {
//       el.removeChild(el.firstChild);
//   }
  appendLayerQuery(NYCDataset, emptyQuery);
  
  // Text explanation for the selection drop down
  g2.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of injury/fatality to explore:");
  
//To Do
  switch(v) {
    case "m_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20MOTORIST%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_motorist_injured > 0";
      
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "m_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20MOTORIST%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_motorist_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "p_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20PEDESTRIANS%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_pedestrians_injured > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "p_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20PEDESTRIANS%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_pedestrians_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "c_inj":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20CYCLIST%20INJURED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_cyclist_injured > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
    case "c_dead":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz2_mode_pivot_NUMBER%20OF%20CYCLIST%20KILLED.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE number_of_cyclist_killed > 0";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g2, viz_url, viz_title, z2);
      
      break;
      
  }
}
// Function to return the respective parameters for the visualization function based on the selected option in the drop down menu
function report3(v) {
  var text = this.getSelectedText('facs');
  viz_title = "Number of Accidents due to "+text+" per year for each borough:"
  // Clear element when selection is changed  
  var el = document.getElementById("vis3");
  el.innerHTML = '';
//   while (el.firstChild) {
//       el.removeChild(el.firstChild);
//   }
    appendLayerQuery(NYCDataset, emptyQuery);
  // Text explanation for the selection drop down
  g3.append("text")
    .attr("x", 0)
    .attr("y", -33)
//     .attr("dy", ".35em")
    .attr("font-family", "sans-serif")
    .attr("font-size", "14px")
    .text("Select the type of contributing factor to explore:");
  
//To Do
  switch(v) {
      
    case "o1":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Driver%20Inattention--Distraction.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Driver Inattention/Distraction'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o2":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Failure%20to%20Yield%20Right-of-Way.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Failure to Yield Right-of-Way'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o3":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Fatigued--Drowsy.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Fatigued/Drowsy'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o4":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Backing%20Unsafely.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Backing Unsafely'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o5":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Other%20Vehicular.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Other Vehicular'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o6":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Following%20Too%20Closely.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Following Too Closely'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o7":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Turning%20Improperly.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Turning Improperly'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o8":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Lost%20Consciousness.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Lost Consciousness'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o9":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Passing%20or%20Lane%20Usage%20Improper.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Passing or Lane Usage Improper'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o10":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Traffic%20Control%20Disregarded.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Traffic Control Disregarded'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o11":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Driver%20Inexperience.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Driver Inexperience'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o12":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Prescription%20Medication.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Prescription Medication'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o13":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Unsafe%20Lane%20Changing.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Unsafe Lane Changing'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o14":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Pavement%20Slippery.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Pavement Slippery'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o15":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Outside%20Car%20Distraction.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Outside Car Distraction'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o16":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Alcohol%20Involvement.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Alcohol Involvement'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o17":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Physical%20Disability.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Physical Disability'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o18":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Oversized%20Vehicle.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Oversized Vehicle'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o19":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Reaction%20to%20Other%20Uninvolved%20Vehicle.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Reaction to Other Uninvolved Vehicle'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
      
    case "o20":
      viz_url = "https://raw.githubusercontent.com/Ishmita910/Datasets/master/viz3_factor_pivot_Unsafe%20Speed.csv";
      sql_query = "SELECT * FROM roshansridhar.nyc_motor_vehicle_collisions WHERE contributing_factor='Unsafe Speed'";
      appendLayerQuery(NYCDataset, sql_query);
      dispViz(g3, viz_url, viz_title, z3);      
      break;
  }
}</script></body>
</html>
